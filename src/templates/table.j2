<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ title }}</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/tabulator-tables@6.2.5/dist/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://oss.sheetjs.com/sheetjs/xlsx.full.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@6.2.5/dist/js/tabulator.min.js"></script>
</head>
<style>
    .tabulator {
        font-family: 'DM Mono', monospace !important;
    }

    .tabulator .tabulator-header .tabulator-col {
        font-family: 'DM Mono', monospace !important;
    }

    .tabulator .tabulator-tableHolder .tabulator-row .tabulator-cell {
        font-family: 'DM Mono', monospace !important;
    }

    .tabulator .tabulator-header {
        background-color: #282A2D !important;
        color: white !important;
    }

    .tabulator .tabulator-header .tabulator-col {
        background-color: #282A2D !important;
        color: white !important;
        padding: 16px 12px;
    }

    .tabulator .tabulator-tableHolder .tabulator-row .tabulator-cell {
        padding: 16px 12px;
    }

    .tabulator .tabulator-tableHolder .tabulator-row:nth-child(even) {
        background-color: #f2f2f2;
    }

    .tabulator .tabulator-tableHolder .tabulator-row:hover {
        background-color: #ddd;
    }
</style>
<body style="margin: 0; padding: 0;">
<!-- Header Bar -->
<div style="position: relative; width: 1648px; height: 48px; margin: 32px auto 0 auto; background-color: #282A2D; color: white;">
    <!-- Tao Symbol on the Left -->
    <div style="position: absolute; width: 48px; height: 48px; left: 16px; top: 0; text-align: center;
            font-family: 'GFS Neohellenic', serif; font-weight: 400; font-size: 48px; line-height: 48px; color: #ffffff;">
        Ï„
    </div>
    <!-- Table Info slightly off-center and constrained to one line -->
    <div style="position: absolute; left: 25%; transform: translateX(-25%); top: 12px; width: 60%;
            font-family: 'DM Mono', monospace; font-weight: 400; font-size: 12px; letter-spacing: 0.05em;
            text-transform: uppercase; color: #ffffff; white-space: nowrap;">
        {{ table_info }}
    </div>
</div>

<!-- Filter Section -->
<div style="margin: 20px auto; text-align: center;">
    <div style="display: inline-block;">
        <select id="filter-field">
            <option></option>
            {% for col in column_names %}
                <option value="{{ col }}">{{ col }}</option>
            {% endfor %}
        </select>

        <select id="filter-type">
            <option value="=">=</option>
            <option value="<"><</option>
            <option value="<="><=</option>
            <option value=">">></option>
            <option value=">=">>=</option>
            <option value="!=">!=</option>
            <option value="like">like</option>
        </select>

        <input id="filter-value" type="text" placeholder="value to filter">

        <button id="filter-clear">Clear Filter</button>
    </div>
</div>

<!-- Table Placeholder (for reference) -->
<div id="my-table" style="width: 1648px; margin: 20px auto;">
    <!-- Table content will go here -->
</div>

<div style="margin: 20px auto; text-align: center;">
    <button id="download-csv">Download CSV</button>
    <button id="download-json">Download JSON</button>
    <button id="download-xlsx">Download XLSX</button>
    <button id="download-html">Download HTML</button>
</div>

</body>

<script>
    const columns = {{ columns|safe }};
    columns.forEach(column => {
        if (column.customFormatter === "millify") {
            column.formatter = millify;
            delete column.customFormatter;
        }
    });
    const None = null;
    const table = new Tabulator("#my-table",
        {
            columns: columns,
            data: {{ rows|safe }},
            pagination: "local",
            paginationSize: 50,
            paginationSizeSelector: [50, 100, 150, 200],
            movableColumns: true,
            paginationCounter: "rows",
            layout: "fitColumns",
    {% if tree %} dataTree:true, {% endif %}
        }
    )
    //Define variables for input elements
    const fieldEl = document.getElementById("filter-field");
    const typeEl = document.getElementById("filter-type");
    const valueEl = document.getElementById("filter-value");

    //Custom filter example
    function customFilter(data) {
        return data.car && data.rating < 3;
    }

    //Trigger setFilter function with correct parameters
    function updateFilter() {
        var filterVal = fieldEl.options[fieldEl.selectedIndex].value;
        var typeVal = typeEl.options[typeEl.selectedIndex].value;

        var filter = filterVal == "function" ? customFilter : filterVal;

        if (filterVal == "function") {
            typeEl.disabled = true;
            valueEl.disabled = true;
        } else {
            typeEl.disabled = false;
            valueEl.disabled = false;
        }

        if (filterVal) {
            table.setFilter(filter, typeVal, valueEl.value);
        }
    }

    function millify(cell, formatterParams, onRendered) {
        const millNames = ["", "K", "M", "B", "T"];
        const n = cell.getValue();
        const nAbs = Math.abs(n);
        const millIdx = Math.max(0, Math.min(millNames.length - 1, Math.floor(nAbs === 0 ? 0 : Math.log10(nAbs) / 3)));

        return (n / Math.pow(10, 3 * millIdx)).toFixed(2) + millNames[millIdx];
    }

    //Update filters on value change
    document.getElementById("filter-field").addEventListener("change", updateFilter);
    document.getElementById("filter-type").addEventListener("change", updateFilter);
    document.getElementById("filter-value").addEventListener("keyup", updateFilter);

    //Clear filters on "Clear Filters" button click
    document.getElementById("filter-clear").addEventListener("click", function () {
        fieldEl.value = "";
        typeEl.value = "=";
        valueEl.value = "";

        table.clearFilter();
    });

    //trigger download of data.csv file
    document.getElementById("download-csv").addEventListener("click", function () {
        table.download("csv", "{{ title }}.csv");
    });

    //trigger download of data.json file
    document.getElementById("download-json").addEventListener("click", function () {
        table.download("json", "{{ title }}.json");
    });

    //trigger download of data.xlsx file
    document.getElementById("download-xlsx").addEventListener("click", function () {
        table.download("xlsx", "{{ title }}.xlsx", {sheetName: "My Data"});
    });

    //trigger download of data.html file
    document.getElementById("download-html").addEventListener("click", function () {
        table.download("html", "{{ title }}.html", {style: true});
    });

</script>

</html>